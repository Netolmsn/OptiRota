<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>OptiRota - Dashboard VRPTW</title>

  <!-- Plotly e Tailwind -->
  <script src="https://cdn.plot.ly/plotly-latest.min.js"></script>
  <script src="https://cdn.tailwindcss.com"></script>

  <style>
    :root {
      --bg: #0f1724;
      --panel: #111827;
      --muted: #9ca3af;
    }
    html, body {
      height: 100%;
      margin: 0;
      font-family: Inter, Arial, sans-serif;
      background: radial-gradient(ellipse at center, rgba(2,6,23,0.6), rgba(2,6,23,1));
      color: #e6eef8;
    }
    .app-shell { display: flex; height: 100vh; }

    /* ================= MENU LATERAL ================= */
    .left-menu {
      width: 280px;
      background: linear-gradient(180deg, rgba(17,24,39,0.95), rgba(7,12,20,0.95));
      border-right: 1px solid rgba(255,255,255,0.03);
      padding: 18px;
      box-sizing: border-box;
      overflow-y: auto;
    }
    .left-menu h2 { color: #cfe6f5; margin: 0 0 12px 0; }
    .left-menu ul { list-style: none; padding: 0; margin: 0; color: var(--muted); font-size: 14px; }
    .left-menu li { margin: 8px 0; }
    .left-menu a { color: inherit; text-decoration: none; }
    .left-menu a:hover { color: #06b6d4; }

    /* ================= FORMUL√ÅRIO ================= */
    .add-client-section {
      margin-top: 20px;
      background: rgba(255,255,255,0.03);
      padding: 12px;
      border-radius: 8px;
      border: 1px solid rgba(255,255,255,0.05);
    }
    .add-client-section h3 {
      color: #9fb4c9;
      font-size: 14px;
      margin: 0 0 8px 0;
    }
    .add-client-section label {
      display: block;
      margin-top: 6px;
      font-size: 12px;
      color: var(--muted);
    }
    .add-client-section input {
      width: 100%;
      padding: 6px;
      border: none;
      border-radius: 4px;
      margin-top: 2px;
      background: rgba(255,255,255,0.06);
      color: #fff;
    }
    .add-client-section button {
      margin-top: 10px;
      width: 100%;
      background: #06b6d4;
      color: #042f3a;
      padding: 8px;
      border: none;
      border-radius: 6px;
      cursor: pointer;
      font-weight: 600;
    }
    .add-client-section button:hover { background: #0891b2; }

    /* ================= √ÅREA PRINCIPAL ================= */
    .workspace {
      flex: 1;
      display: flex;
      gap: 18px;
      padding: 18px;
      box-sizing: border-box;
    }

    .map-area {
      flex: 1.2;
      min-width: 720px;
      background: #fff;
      border-radius: 8px;
      overflow: hidden;
      box-shadow: 0 10px 30px rgba(2,6,23,0.6);
      position: relative;
    }

    .map-frame { border: none; width: 100%; height: 100%; }

    /* ================= PAINEL DIREITO ================= */
    .right-panel {
      width: 420px;
      background: linear-gradient(180deg, rgba(8,18,28,0.95), rgba(6,12,20,0.9));
      border-radius: 8px;
      padding: 18px;
      box-sizing: border-box;
      color: #cbd5e1;
      overflow-y: auto;
    }

    .kpi-grid { display: flex; gap: 12px; margin-bottom: 18px; }
    .kpi {
      flex: 1;
      background: rgba(255,255,255,0.02);
      padding: 12px;
      border-radius: 6px;
    }
    .kpi .label { font-size: 12px; color: var(--muted); }
    .kpi .value { font-size: 18px; font-weight: 700; color: #fff; margin-top: 4px; }

    .section-title {
      font-weight: 700;
      color: #9fb4c9;
      margin: 12px 0;
      font-size: 14px;
      text-transform: uppercase;
      border-bottom: 1px solid rgba(255,255,255,0.08);
      padding-bottom: 4px;
    }
    .chart-card {
      background: rgba(255,255,255,0.03);
      padding: 10px;
      border-radius: 8px;
      margin-bottom: 20px;
    }
  </style>
</head>

<body>
<div class="app-shell">
  <!-- ========== MENU LATERAL ========== -->
  <nav class="left-menu">
    <h2>OptiRota</h2>
    <ul>
      <li><a href="#">Dashboard</a></li>
      <li><a href="#">Rotas Otimizadas</a></li>
      <li><a href="#">Clientes</a></li>
      <li><a href="#">Configura√ß√µes</a></li>
    </ul>

    <div class="add-client-section">
      <h3>Adicionar Cliente</h3>
      <form id="clienteForm">
        <label>ID:<input name="ID" required></label>
        <label>Lat:<input name="Lat" type="number" step="any" required></label>
        <label>Lon:<input name="Lon" type="number" step="any" required></label>
        <label>Demanda:<input name="Demanda" type="number" required></label>
        <label>In√≠cio (h):<input name="T_Inicio_h" type="number" step="0.5" required></label>
        <label>Fim (h):<input name="T_Fim_h" type="number" step="0.5" required></label>
        <button type="submit">Adicionar</button>
      </form>
    </div>
  </nav>

  <!-- ========== CONTE√öDO PRINCIPAL ========== -->
  <main class="workspace">
    <!-- Mapa -->
    <section class="map-area">
      <iframe class="map-frame" src="rotas_otimizadas.html"></iframe>
    </section>

    <!-- Painel direito -->
    <aside class="right-panel">
      <div style="font-weight:800;color:#bfe8ff; font-size:16px;">üìà KPIs</div>
      <div class="kpi-grid">
        <div class="kpi">
          <div class="label">CUSTO TOTAL</div>
          <div class="value" id="kpi-cost">‚Ç¨0</div>
        </div>
        <div class="kpi">
          <div class="label">ATRASO TOTAL</div>
          <div class="value" id="kpi-delay">0 min</div>
        </div>
        <div class="kpi">
          <div class="label">% NO HOR√ÅRIO</div>
          <div class="value" id="kpi-ontime">0%</div>
        </div>
      </div>

      <!-- ===========================
           Se√ß√£o de An√°lises de Rotas
      ============================ -->
      <section id="painel-graficos">
        <div class="section-title">üìä An√°lise de Rotas</div>

        <div class="chart-card">
          <h4 style="margin:0 0 6px 0; color:#a5f3fc; font-size:13px;">Demanda por Zona</h4>
          <div id="grafico_demanda" style="width:100%; height:250px;"></div>
        </div>

        <div class="chart-card">
          <h4 style="margin:0 0 6px 0; color:#a5f3fc; font-size:13px;">Janela de Atendimento (Gantt)</h4>
          <div id="grafico_gantt" style="width:100%; height:320px;"></div>
        </div>
      </section>
    </aside>
  </main>
</div>

<!-- ===========================
     Scripts
=========================== -->
<script>
async function carregarGraficos() {
  try {
    const resDemanda = await fetch('/api/grafico_demanda');
    const figDemanda = await resDemanda.json();
    Plotly.newPlot('grafico_demanda', figDemanda.data, figDemanda.layout, {responsive: true});

    const resGantt = await fetch('/api/grafico_gantt');
    const figGantt = await resGantt.json();
    Plotly.newPlot('grafico_gantt', figGantt.data, figGantt.layout, {responsive: true});
  } catch (err) {
    console.error("Erro ao carregar gr√°ficos:", err);
    document.getElementById('painel-graficos').innerHTML +=
      "<p style='color:red;'>‚ùå Erro ao carregar gr√°ficos. Verifique o servidor Flask.</p>";
  }
}

// Recarrega gr√°ficos ao adicionar cliente
document.getElementById('clienteForm').addEventListener('submit', async (e) => {
  e.preventDefault();
  const data = Object.fromEntries(new FormData(e.target).entries());

  try {
    const res = await fetch('/api/adicionar_cliente', {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify(data)
    });
    const json = await res.json();
    if (json.mensagem) {
      alert("‚úÖ Cliente adicionado com sucesso!");
      e.target.reset();
      await carregarGraficos();
    } else {
      alert("‚ùå Erro: " + json.erro);
    }
  } catch (err) {
    console.error(err);
    alert("Erro ao conectar com o servidor.");
  }
});

document.addEventListener('DOMContentLoaded', carregarGraficos);
</script>
</body>
</html>
