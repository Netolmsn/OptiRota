<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Dashboard de Otimiza√ß√£o de Rotas (VRPTW)</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        body {
            font-family: 'Inter', sans-serif;
        }
        .tab-content { display: none; min-height: 80vh; }
        .tab-button { border-bottom: 3px solid transparent; }
        .tab-button.active {
            color: #1d4ed8;
            border-bottom: 3px solid #1d4ed8;
            font-weight: 700;
        }
        iframe { height: calc(100vh - 180px); }
    </style>
</head>
<body class="bg-gray-100 text-gray-800">

    <div id="parameter-bar" class="bg-white p-4 shadow-md flex flex-wrap justify-between items-center gap-4">
        <h3 class="text-lg font-semibold text-gray-700">Par√¢metros de Simula√ß√£o:</h3>
        
        <div class="flex flex-wrap items-center gap-4">
            <label class="flex flex-col text-sm font-medium text-gray-600">
                Capacidade (un.):
                <input type="number" id="capacity" value="20" min="1" class="mt-1 p-2 border border-gray-300 rounded-md w-24 focus:ring-blue-500 focus:border-blue-500">
            </label>
            
            <label class="flex flex-col text-sm font-medium text-gray-600">
                Velocidade (km/min):
                <input type="number" id="speed" value="1.0" step="0.1" class="mt-1 p-2 border border-gray-300 rounded-md w-24 focus:ring-blue-500 focus:border-blue-500">
            </label>
            
            <label class="flex flex-col text-sm font-medium text-gray-600">
                Custo/km (R$):
                <input type="number" id="cost_km" value="0.5" step="0.1" class="mt-1 p-2 border border-gray-300 rounded-md w-24 focus:ring-blue-500 focus:border-blue-500">
            </label>
            
            <button onclick="recalculateOptimization()" class="mt-auto bg-green-600 hover:bg-green-700 text-white font-bold py-2 px-4 rounded-lg shadow-md transition duration-200">
                Recalcular e Atualizar
            </button>
        </div>
        
        <span id="statusMessage" class="text-blue-600 font-semibold text-sm">Aguardando a primeira otimiza√ß√£o...</span>
    </div>
    
    <div class="tab-menu bg-white px-4 shadow-lg flex items-center border-b-2 border-gray-200 mt-1">
        <h2 class="text-xl font-bold text-gray-800 py-3 flex-grow">Dashboard VRPTW</h2>
        
        <button id="btnRotas" class="tab-button py-3 px-6 text-gray-500 font-medium transition duration-200 hover:text-blue-700" onclick="openTab(event, 'Rotas')">
            üó∫Ô∏è Mapa de Rotas Otimizadas
        </button>
        <button id="btnGantt" class="tab-button py-3 px-6 text-gray-500 font-medium transition duration-200 hover:text-blue-700" onclick="openTab(event, 'Gantt')">
            ‚è±Ô∏è Gr√°fico de Gantt (Cronograma)
        </button>
    </div>

    <div class="tab-container p-4">
        
        <div id="Rotas" class="tab-content bg-white p-2 rounded-xl shadow-xl border border-gray-200" style="display: block;">
            <iframe id="mapFrame" src="/rotas_otimizadas" class="w-full rounded-lg"></iframe> 
        </div>

        <div id="Gantt" class="tab-content bg-white p-2 rounded-xl shadow-xl border border-gray-200">
            <iframe id="ganttFrame" src="/gantt_schedule" class="w-full rounded-lg"></iframe>
        </div>
    </div>

    <aside style="position:fixed; right:0; top:0; width:300px; height:100%; background:#f4f4f4; padding:20px; box-shadow:-2px 0 5px rgba(0,0,0,0.1);">
      <h2>Adicionar Cliente</h2>
      <form id="clienteForm">
        <label>ID: <input name="ID" required></label><br>
        <label>Lat: <input name="Lat" type="number" step="any" required></label><br>
        <label>Lon: <input name="Lon" type="number" step="any" required></label><br>
        <label>Demanda: <input name="Demanda" type="number" required></label><br>
        <label>In√≠cio (h): <input name="T_Inicio_h" type="number" required></label><br>
        <label>Fim (h): <input name="T_Fim_h" type="number" required></label><br>
        <button type="submit">Enviar</button>
      </form>
      <div id="status"></div>
    </aside>

    <script>
        function openTab(evt, tabName) {
            document.querySelectorAll(".tab-content").forEach(el => el.style.display = "none");
            document.querySelectorAll(".tab-button").forEach(el => el.classList.remove("active"));
            document.getElementById(tabName).style.display = "block";
            evt.currentTarget.classList.add("active");
        }

        async function recalculateOptimization() {
            const params = {
                capacity: Number(document.getElementById('capacity').value),
                speed: Number(document.getElementById('speed').value),
                cost_km: Number(document.getElementById('cost_km').value)
            };
            const statusEl = document.getElementById('statusMessage');
            statusEl.textContent = "‚öôÔ∏è Otimizando rotas...";
            statusEl.className = "text-blue-600 font-semibold text-sm";

            try {
                const res = await fetch('/optimize', {
                    method: 'POST',
                    headers: {'Content-Type':'application/json'},
                    body: JSON.stringify(params)
                });
                const data = await res.json();

                if (data.status === 'success') {
                    statusEl.textContent = `‚úÖ Custo final: R$ ${data.final_cost.toFixed(2)} ‚Äî gr√°ficos atualizados.`;
                    statusEl.className = "text-green-600 font-semibold text-sm";
                    const t = new Date().getTime();
                    document.getElementById('mapFrame').src = '/rotas_otimizadas?t='+t;
                    document.getElementById('ganttFrame').src = '/gantt_schedule?t='+t;
                } else {
                    statusEl.textContent = "‚ùå Erro: " + data.message;
                    statusEl.className = "text-red-600 font-semibold text-sm";
                }
            } catch (err) {
                statusEl.textContent = "‚ùå Falha na conex√£o: " + err.message;
                statusEl.className = "text-red-600 font-semibold text-sm";
            }
        }

        document.getElementById('clienteForm').onsubmit = async function(e) {
            e.preventDefault();
            const data = Object.fromEntries(new FormData(this).entries());
            const res = await fetch('/api/novo_cliente', {
                method: 'POST',
                headers: {'Content-Type':'application/json'},
                body: JSON.stringify(data)
            });
            const msg = await res.text();
            document.getElementById('status').textContent = msg;
        };

        document.addEventListener('DOMContentLoaded', () => {
            recalculateOptimization();
        });
    </script>
</body>
</html>
